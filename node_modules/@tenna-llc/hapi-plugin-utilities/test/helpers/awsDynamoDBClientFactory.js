'use strict';

const Lab = require('@hapi/lab');
const Code = require('@hapi/code');
const { DynamoDB } = require('@tenna-llc/aws-sdk-wrapper');
const { AWSDynamoDBClientFactory } = require('../../src/helpers');

const { before, after, beforeEach, afterEach, describe, it } = (exports.lab = Lab.script());
const expect = Code.expect;

let awsDynamoDBClientFactory = null;

describe('Helpers', () => {
    describe('AWSDynamoDBClientFactory', () => {
        beforeEach(async () => {
            awsDynamoDBClientFactory = new AWSDynamoDBClientFactory();
        });

        describe('add', () => {
            it('should error when client configuration does not have a name', async () => {
                const clientConfiguration = {
                    config: {}
                };

                expect(() => awsDynamoDBClientFactory.add(clientConfiguration)).to.throw(Error, '"name" is required');
            });

            it('should error when client configuration has a name not of type string', async () => {
                const clientConfiguration = {
                    name: new Date(),
                    config: {}
                };

                expect(() => awsDynamoDBClientFactory.add(clientConfiguration)).to.throw(
                    Error,
                    '"name" must be a string'
                );
            });

            it('should not error when client configuration does not have config', async () => {
                const clientConfiguration = {
                    name: 'foo'
                };

                expect(() => awsDynamoDBClientFactory.add(clientConfiguration)).to.not.throw();
            });

            it('should error when client configuration has a config not of type object', async () => {
                const clientConfiguration = {
                    name: 'foo',
                    config: 'bar'
                };

                expect(() => awsDynamoDBClientFactory.add(clientConfiguration)).to.throw(
                    Error,
                    '"config" must be of type object'
                );
            });

            it('should error when a client configuration with the same name has already been built', async () => {
                const clientConfiguration = {
                    name: 'foo'
                };

                expect(() => awsDynamoDBClientFactory.add(clientConfiguration)).to.not.throw();
                expect(() => awsDynamoDBClientFactory.add(clientConfiguration)).to.throw(
                    Error,
                    'A configuration with name of (foo) has already been added'
                );
            });
        });

        describe('count', () => {
            it('should initialize with 0', async () => {
                expect(awsDynamoDBClientFactory.count()).to.equal(0);
            });

            it('should be 2 after 2 client configurations are added', async () => {
                awsDynamoDBClientFactory.add({
                    name: 'client1'
                });

                awsDynamoDBClientFactory.add({
                    name: 'client2'
                });

                expect(awsDynamoDBClientFactory.count()).to.equal(2);
            });
        });

        describe('get', () => {
            it('should error when client configuration does not exist', async () => {
                expect(() => awsDynamoDBClientFactory.build('foo')).to.throw(
                    Error,
                    'A configuration with name of (foo) does not exist'
                );
            });

            it('should fetch configuration when it exist', async () => {
                const clientConfiguration = {
                    name: 'client1',
                    config: {
                        hello: 'world'
                    }
                };

                awsDynamoDBClientFactory.add(clientConfiguration);

                let sut = undefined;
                expect(() => (sut = awsDynamoDBClientFactory.get('client1'))).to.not.throw();
                expect(sut).to.exist().and.to.include(clientConfiguration.config);
            });
        });

        describe('build', () => {
            it('should error when client configuration does not exist', async () => {
                expect(() => awsDynamoDBClientFactory.build('foo')).to.throw(
                    Error,
                    'A configuration with name of (foo) does not exist'
                );
            });

            it('should have built a client with empty config', async () => {
                awsDynamoDBClientFactory.add({
                    name: 'client1'
                });

                let sut = undefined;
                expect(() => (sut = awsDynamoDBClientFactory.build('client1'))).to.not.throw();
                expect(sut).to.exist().and.to.be.an.instanceof(DynamoDB);
            });

            it('should have built a client with config', async () => {
                const clientConfiguration = {
                    name: 'client1',
                    config: {
                        region: 'us-west-1'
                    }
                };

                awsDynamoDBClientFactory.add(clientConfiguration);

                let sut = undefined;
                expect(() => (sut = awsDynamoDBClientFactory.build('client1'))).to.not.throw();
                expect(sut).to.exist().and.to.be.an.instanceof(DynamoDB);
                expect(sut.params).to.include(clientConfiguration.config);
            });
        });
    });
});
