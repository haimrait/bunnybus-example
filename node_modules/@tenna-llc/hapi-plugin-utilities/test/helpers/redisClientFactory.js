'use strict';

const Lab = require('@hapi/lab');
const Code = require('@hapi/code');
const Redis = require('ioredis');
const { RedisClientFactory } = require('../../src/helpers');

const { before, after, beforeEach, afterEach, describe, it } = (exports.lab = Lab.script());
const expect = Code.expect;

let redisClientFactory = null;

describe('Helpers', () => {
    describe('RedisClientFactory', () => {
        beforeEach(async () => {
            redisClientFactory = new RedisClientFactory();
        });

        describe('add', () => {
            it('should error when client configuration does not have a name', async () => {
                const clientConfiguration = {
                    config: {}
                };

                expect(() => redisClientFactory.add(clientConfiguration)).to.throw(Error, '"name" is required');
            });

            it('should error when client configuration has a name not of type string', async () => {
                const clientConfiguration = {
                    name: new Date(),
                    config: {}
                };

                expect(() => redisClientFactory.add(clientConfiguration)).to.throw(Error, '"name" must be a string');
            });

            it('should not error when client configuration does not have config', async () => {
                const clientConfiguration = {
                    name: 'foo'
                };

                expect(() => redisClientFactory.add(clientConfiguration)).to.not.throw();
            });

            it('should error when client configuration has a config not of type object', async () => {
                const clientConfiguration = {
                    name: 'foo',
                    config: 'bar'
                };

                expect(() => redisClientFactory.add(clientConfiguration)).to.throw(
                    Error,
                    '"config" must be of type object'
                );
            });

            it('should error when a client configuration with the same name has already been built', async () => {
                const clientConfiguration = {
                    name: 'foo'
                };

                expect(() => redisClientFactory.add(clientConfiguration)).to.not.throw();
                expect(() => redisClientFactory.add(clientConfiguration)).to.throw(
                    Error,
                    'A configuration with name of (foo) has already been added'
                );
            });
        });

        describe('count', () => {
            it('should initialize with 0', async () => {
                expect(redisClientFactory.count()).to.equal(0);
            });

            it('should be 2 after 2 client configurations are added', async () => {
                redisClientFactory.add({
                    name: 'client1'
                });

                redisClientFactory.add({
                    name: 'client2'
                });

                expect(redisClientFactory.count()).to.equal(2);
            });
        });

        describe('get', () => {
            it('should error when client configuration does not exist', async () => {
                expect(() => redisClientFactory.build('foo')).to.throw(
                    Error,
                    'A configuration with name of (foo) does not exist'
                );
            });

            it('should fetch configuration when it exist', async () => {
                const clientConfiguration = {
                    name: 'client1',
                    config: {
                        hello: 'world'
                    }
                };

                redisClientFactory.add(clientConfiguration);

                let sut = undefined;
                expect(() => (sut = redisClientFactory.get('client1'))).to.not.throw();
                expect(sut).to.exist().and.to.include(clientConfiguration.config);
            });
        });

        describe('build', () => {
            it('should error when client configuration does not exist', async () => {
                expect(() => redisClientFactory.build('foo')).to.throw(
                    Error,
                    'A configuration with name of (foo) does not exist'
                );
            });

            it('should have built a client with empty config', async () => {
                redisClientFactory.add({
                    name: 'client1'
                });

                let sut = undefined;
                expect(() => (sut = redisClientFactory.build('client1'))).to.not.throw();
                expect(sut).to.exist().and.to.be.an.instanceof(Redis);
                sut.quit();
            });

            it('should have built a client with config', async () => {
                const clientConfiguration = {
                    name: 'client1',
                    config: {
                        host: '127.0.0.1'
                    }
                };

                redisClientFactory.add(clientConfiguration);

                let sut = undefined;
                expect(() => (sut = redisClientFactory.build('client1'))).to.not.throw();
                expect(sut).to.exist().and.to.be.an.instanceof(Redis);
                expect(sut.options).to.include(clientConfiguration.config);
                sut.quit();
            });
        });
    });
});
