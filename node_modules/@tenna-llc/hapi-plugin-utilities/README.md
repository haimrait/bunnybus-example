# hapi-plugin-utilities
A support plugin that provides graceful shutdown, version reporting, health reporting and so forth.

![Test](https://github.com/tenna-llc/hapi-plugin-utilities/workflows/Test/badge.svg)

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [Installation](#installation)
- [Dependencies](#dependencies)
  - [Installing Dependencies](#installing-dependencies)
- [Configuration](#configuration)
  - [Plugin Configuration](#plugin-configuration)
  - [Default Configuration](#default-configuration)
  - [Specification](#specification)
    - [Properties](#properties)
- [Usage](#usage)
  - [Example](#example)
    - [Client Factory](#client-factory)
      - [Interface](#interface)
        - [BunnyBus](#bunnybus)
        - [AWS S3](#aws-s3)
        - [AWS DynamoDB](#aws-dynamodb)
        - [AWS Cognito](#aws-cognito)
        - [Redis](#redis)
        - [Redis Cluster](#redis-cluster)
        - [SuperAgent](#superagent)
        - [Sequelize](#sequelize)
    - [Top Level Version Reporter](#top-level-version-reporter)
    - [Health Reporter](#health-reporter)
      - [Interface](#interface-1)
    - [Shutdown Orchestrator](#shutdown-orchestrator)
      - [Interface](#interface-2)
  - [Dependencies](#dependencies-1)
- [Testing](#testing)
  - [Running the test suite](#running-the-test-suite)
  - [Linting](#linting)
- [Documentation](#documentation)
  - [Updating TOC for Documentation](#updating-toc-for-documentation)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# Installation
```
➜  test npm login --registry=https://npm.pkg.github.com
Username: <your github username>
Password: <your github api token>
Email: (this IS public) <your email>
Logged in as <your github username> on https://npm.pkg.github.com/.
➜  npm i @tenna-llc/hapi-plugin-utilities
```

# Dependencies

## Installing Dependencies
Install dependencies declared from [`package.json`](package.json).

```
npm i
```

# Configuration

## Plugin Configuration
This [`hapi` plugin](https://hapi.dev/api/?v=18.4.0#plugins) is passed an `options` parameter during
the plugin registration.  The plugin registration is handled on the `hapi` server code base.  For us,
we use [`glue`])(https://github.com/hapijs/glue) to compose plugins through configuration.  We will
be using the Glue `manifest.js` file for configuration.

## Default Configuration
We have the option of using safe defaults in absence of user provided configuration by specifying it
[here](src/defaultOptions.js).  Default configuration is overridden by user provided configuration via
[`Object.assign(...)`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign).

## Specification
Write your options contract here so we know how to configure this plugin.

```json
{
    "serverStopTimeoutMilliseconds" : 5000,
    "paths": {
        "health": "/health",
        "topLevelVersion": "/version"
    },
    "clients": {
        "bunnyBus": {
            "us-east-1": { <config> }
        },
        "awsS3": {
            "us-east-1": { <conrig> }
        },
        "awsDynamoDB": {
            "us-east-1": { <config> }
        },
        "awsCognito": {
            "us-east-1": { <config> }
        },
        "redis": {
            "us-east-1": { <config> }
        },
        "redisCluster": {
            "us-east-1": { "nodes": [ <list of nodes >], "options": { <config> } }
        },
        "superAgent": {
            "crud": { <config> }
        },
        "sequelize": {
            "db1": { <config> }
        }
    }
}
```

### Properties

* `serverStopTimeoutMilliseconds` : Timeout value given to [`Hapi.server.stop()`](https://hapi.dev/api/?v=19.1.1#-await-serverstopoptions) to set the grace period before force connection closure.  Defaults to `5000`.  **Optional**
* `paths`
  * `health`: the path to health reporter
  * `topLevelVersion` : the path to the top level version reporter
* `clients` : connection configuration region.
  * `bunnyBus` : BunnyBus connection configuration region.  Can contain name value pairs where the value is a [BunnyBus server configuration](https://github.com/tenna-llc/bunnybus/blob/master/API.md#new-bunnybusconfig).
  * `awsS3` : S3 Client configuration region.  Can contain name value pairs where the value is an [AWS S3 SDK params object](https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#constructor-property)
  * `awsDynamoDB` : DynamoDB Client configuration region.  Can contain name value pairs where the value is an [AWS DynamoDB SDK params object](https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/DynamoDB.html#constructor-property)
  * `superAgent` : SuperAgent Client configuration region.  CVan contain name value pairs where the value is a [ProxyAgent server configuration](https://github.com/tenna-llc/superagent-wrapper/blob/master/API.md#new-proxyagentoptions).

# Usage

## Example

### Client Factory
Configuration for building shared connection clients.

#### Interface
This component exposes itself through the following keys (`bunnyBusClientFactory`, `s3ClientFactory`, `dynamoDBClientFactory`, `redisClientFactory`, `sequelizeClientFactor`, `superAgentClientFactory`).

##### BunnyBus
* `bunnyBusClientFactory.add(configuration)` : Add a configuration where the configuration is the form `{ name, config }`.
* `bunnyBusClientFactory.get(name)` : Retrieves a configuration based on `name`.
* `bunnyBusClientFactory.build(name)` : Builds a BunnyBus client based on the configuration fetch from `name`.
* `bunnyBusClientFactory.count()` : Returns the number of BunnyBus client configurations.

```javascript
const Hapi = require('@hapi/hapi');

const server = new Hapi.server();

await server.register({
    plugin: require('@tenna-llc/hapi-plugin-utilities'),
    options: { clients: { bunnyBus: { 'us-east-1': host: 127.0.0.1 }} }}
});

// returns a count of bunnybus client configurations
const configurationCount = server.plugins['@tenna-llc/hapi-plugin-utilities'].bunnyBusClientFactory.count();

//returns an instantiated BunnyBus client defined by the registered options
const bunnyBus = server.plugins['@tenna-llc/hapi-plugin-utilities'].bunnyBusClientFactory.build('us-east-1');
```

##### AWS S3
* `s3ClientFactory.add(configuration)` : Add a configuration where the configuration is the form `{ name, config }`.
* `s3ClientFactory.get(name)` : Retrieves a configuration based on `name`.
* `s3ClientFactory.build(name)` : Builds a AWS S3 client based on the configuration fetch from `name`.
* `s3ClientFactory.count()` : Returns the number of AWS S3 client configurations.

```javascript
const Hapi = require('@hapi/hapi');

const server = new Hapi.server();

await server.register({
    plugin: require('@tenna-llc/hapi-plugin-utilities'),
    options: { clients: { awsS3: { 'us-east-1': region: 'us-east-1' }} }}
});

// returns a count of aws s3 client configurations
const configurationCount = server.plugins['@tenna-llc/hapi-plugin-utilities'].s3ClientFactory.count();

//returns an instantiated s3 client defined by the registered options
const s3 = server.plugins['@tenna-llc/hapi-plugin-utilities'].s3ClientFactory.build('us-east-1');
```

##### AWS DynamoDB
* `dynamoDBClientFactory.build(configuration)` : Add a configuration where the configuration is the form `{ name, config }`.
* `dynamoDBClientFactory.get(name)` : Retrieves a configuration based on `name`.
* `dynamoDBClientFactory.build(name)` : Builds a AWS DynamoDB client based on the configuration fetch from `name`.
* `dynamoDBClientFactory.count()` : Returns the number of AWS DynamoDB client configurations.

```javascript
const Hapi = require('@hapi/hapi');

const server = new Hapi.server();

await server.register({
    plugin: require('@tenna-llc/hapi-plugin-utilities'),
    options: { clients: { awsDynamoDB: { 'us-east-1': region: 'us-east-1' }} }}
});

// returns a count of aws dynamoDB client configurations
const configurationCount = server.plugins['@tenna-llc/hapi-plugin-utilities'].dynamoDBClientFactory.count();

//returns an instantiated dynamoDB client defined by the registered options
const dynamoDB = server.plugins['@tenna-llc/hapi-plugin-utilities'].dynamoDBClientFactory.build('us-east-1');
```

##### AWS Cognito
* `cognitoClientFactory.build(configuration)` : Add a configuration where the configuration is the form `{ name, config }`.
* `cognitoClientFactory.get(name)` : Retrieves a configuration based on `name`.
* `cognitoClientFactory.build(name)` : Builds a AWS DynamoDB client based on the configuration fetch from `name`.
* `cognitoClientFactory.count()` : Returns the number of AWS DynamoDB client configurations.

```javascript
const Hapi = require('@hapi/hapi');

const server = new Hapi.server();

await server.register({
    plugin: require('@tenna-llc/hapi-plugin-utilities'),
    options: { clients: { awsCognito: { 'us-east-1': region: 'us-east-1', userPoolId: 'xyz-a34' }} }}
});

// returns a count of aws cognito client configurations
const configurationCount = server.plugins['@tenna-llc/hapi-plugin-utilities'].cognitoClientFactory.count();

//returns an instantiated Cognito client defined by the registered options
const cognito = server.plugins['@tenna-llc/hapi-plugin-utilities'].cognitoClientFactory.build('us-east-1');
```

##### Redis
* `redisClientFactory.build(configuration)` : Add a configuration where the configuration is the form `{ name, config }`.
* `redisClientFactory.get(name)` : Retrieves a configuration based on `name`.
* `redisClientFactory.build(name)` : Builds a Redis client based on the configuration fetch from `name`.
* `redisClientFactory.count()` : Returns the number of Redis client configurations.

```javascript
const Hapi = require('@hapi/hapi');

const server = new Hapi.server();

await server.register({
    plugin: require('@tenna-llc/hapi-plugin-utilities'),
    options: { clients: { redis: { 'us-east-1': host: '127.0.0.1' }} }}
});

// returns a count of redis client configurations
const configurationCount = server.plugins['@tenna-llc/hapi-plugin-utilities'].redisClientFactory.count();

//returns an instantiated redis client defined by the registered options
const redis = server.plugins['@tenna-llc/hapi-plugin-utilities'].redisClientFactory.build('us-east-1');
```

##### Redis Cluster
* `redisClusterClientFactory.build(configuration)` : Add a configuration where the configuration is the form `{ name, config }`.  `config` is the shape of `{ nodes: [], options: {} }`
* `redisClusterClientFactory.get(name)` : Retrieves a configuration based on `name`.
* `redisClusterClientFactory.build(name)` : Builds a Redis client based on the configuration fetch from `name`.
* `redisClusterClientFactory.count()` : Returns the number of Redis client configurations.

```javascript
const Hapi = require('@hapi/hapi');

const server = new Hapi.server();

await server.register({
    plugin: require('@tenna-llc/hapi-plugin-utilities'),
    options: { clients: { redisCluster: { nodes:[{ 'us-east-1': host: '127.0.0.1' }], options: { maxRedirection: 1 }} }}
});

// returns a count of redis cluster client configurations
const configurationCount = server.plugins['@tenna-llc/hapi-plugin-utilities'].redisClusterClientFactory.count();

//returns an instantiated redis cluster client defined by the registered options
const redisCluster = server.plugins['@tenna-llc/hapi-plugin-utilities'].redisClusterClientFactory.build('us-east-1');
```

##### SuperAgent
* `superAgentClientFactory.build(configuration)` : Add a configuration where the configuration is the form `{ name, config }`.
* `superAgentClientFactory.get(name)` : Retrieves a configuration based on `name`.
* `superAgentClientFactory.build(name)` : Builds a [`superagent`](https://www.npmjs.com/package/superagent) agent based on the configuration fetch from `name`.
* `superAgentClientFactory.count()` : Returns the number of `superagent` configurations.

```javascript
const Hapi = require('@hapi/hapi');

const server = new Hapi.server();

await server.register({
    plugin: require('@tenna-llc/hapi-plugin-utilities'),
    options: { clients: { superAgent: { 'crud': host: 'dv3.non-prod.tenna.com', prefix: '/api/v4' }} }}
});

// returns a count of superagent configurations
const configurationCount = server.plugins['@tenna-llc/hapi-plugin-utilities'].superAgentClientFactory.count();

//returns an instantiated superagent client defined by the registered options
const agent = server.plugins['@tenna-llc/hapi-plugin-utilities'].superAgentClientFactory.build('crud');
```

##### Sequelize
* `sequelizeClientFactory.build(configuration)` : Add a configuration where the configuration is the form `{ name, config }`.
* `sequelizeClientFactory.get(name)` : Retrieves a configuration based on `name`.
* `sequelizeClientFactory.build(name)` : Builds a [`sequelize`](https://www.npmjs.com/package/sequelize) client based on the configuration fetch from `name`.
* `sequelizeClientFactory.count()` : Returns the number of `sequelize` configurations.

```javascript
const Hapi = require('@hapi/hapi');

const server = new Hapi.server();

await server.register({
    plugin: require('@tenna-llc/hapi-plugin-utilities'),
    options: { clients: { sequelize: { 'db1': host: 'pg.rds.amazonaws.com', prefix: '/api/v4', dialect: 'postgres' }}
});

// returns a count of sequelize configurations
const configurationCount = server.plugins['@tenna-llc/hapi-plugin-utilities'].sequelizeClientFactory.count();

//returns an instantiated sequelize client defined by the registered options
const sequelize = server.plugins['@tenna-llc/hapi-plugin-utilities'].sequelizeClientFactory.build('crud');
```

### Top Level Version Reporter
Adds an endpoint `/version` that returns a report of dependencies and versions in JSON format.

```javascript
const Hapi = require('@hapi/hapi');

const server = new Hapi.server();

await server.register({
    plugin: require('@tenna-llc/hapi-plugin-utilities'),
    options: { paths: { topLevelVersion: '/version' }}
});
```

```shell
curl localhost:3000/version

# Will print
# {
#    "name": "package-name",
#    "version": "1.2.1",
#    "nodeVersion": "v12.3.4",
#    "dependencies": [],
#    "peerDependencies": []
# }
```

### Health Reporter
Adds an endpont `/health` that returns a report of health probes.  This is to be used with a process orchestration system.

#### Interface
This component exposes itself through the `healthReporter` key as an object with two methods.

* `healthReporter.register(probe)` : Allows registration of probes where the probeis of the form `{ name, asyncFunction, timeout }`.  The `asyncFunction` should return an object response of `{ ok : true/false }`.
* `healthReporter.count()` : Returns the number of registered health probes.

```javascript
const Hapi = require('@hapi/hapi');

const server = new Hapi.server();

await server.register({
    plugin: require('@tenna-llc/hapi-plugin-utilities'),
    options: { paths: { health: '/health' }}
});

await server.plugins['@tenna-llc/hapi-plugin-utilities'].healthReporter.register({
    name: 'health probe 1',
    asyncFunction: async () => {
      // do some work
      return { ok: false, reason: 'system timeout' }
    },
    timeout: 1000
});

// returns a count of registered health probes
const registeredProbeCount = server.plugins['@tenna-llc/hapi-plugin-utilities'].healthReporter.count();
```

```shell
curl localhost:3000/health

# Will print
# {
#    "ok" : true,
#    "probes" : [
#         { "name" : "foo", "response: : { "ok" : true }}
#     ]
# }
```

### Shutdown Orchestrator
Configuration for graceful shutdown

#### Interface
This components exposes itself through the `shutdownOrchestrator` key as an object with two methods.

* `shutdownOrchestrator.register(task)` : Allows registration of shutdown tasks where the task is of the form `{ name, asyncFunction, timeout }`.
* `shutdownOrchestrator.count()` : Returns the number of registered task.

```javascript
const Hapi = require('@hapi/hapi');

const server = new Hapi.server();

await server.register({
    plugin: require('@tenna-llc/hapi-plugin-utilities')
});

await server.plugins['@tenna-llc/hapi-plugin-utilities'].shutdownOrchestrator.register({
    name: 'shutdown routine 1',
    asyncFunction: async () => {
      // do some work
    },
    timeout: 4000
});

// returns a count of registered shutdown tasks
const registeredTaskCount = server.plugins['@tenna-llc/hapi-plugin-utilities'].shutdownOrchestrator.count();

// some events will trigger the above
// SIGTERM
// SIGINT
// Hapi.server.stop

```

## Dependencies
If this plugin is used within another plugin (normal case), then [`Hapi.server.dependency()`](https://hapi.dev/api/?v=19.1.1#-serverdependencydependencies-after) should be used.

# Testing

## Running the test suite
Install dependencies and run the test.

```bash
npm test
```

## Linting
Using [`eslint`](https://eslint.org/) to code cop.

```bash
npm run lint
```

# Documentation

## Updating TOC for Documentation
Run [`doctoc`](https://github.com/thlorenz/doctoc)

```bash
npm run doctoc
```


