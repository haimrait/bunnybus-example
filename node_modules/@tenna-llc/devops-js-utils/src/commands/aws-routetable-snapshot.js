#!/usr/bin/env node
'use strict';

const AWS = require('aws-sdk');
const Args = require('commander');
const PackageMeta = require('../../package.json');

Args.version(PackageMeta.version)
    .option('-r, --region <region>', 'AWS region', 'us-east-1')
    .option('-v, --vpcids <ids...>', 'A list of comma seperated vpc ids')
    .parse(process.argv);

const EC2 = new AWS.EC2({ region: Args.region });

(async () => {
    const vpcParams = {
        VpcIds: Args.vpcids
    };

    const vpcResponse = await EC2.describeVpcs(vpcParams).promise();

    for (const vpc of vpcResponse.Vpcs) {
        const routeTableParams = {
            Filters: [{ Name: 'vpc-id', Values: [vpc.VpcId] }]
        };

        let inProcess = true;

        do {
            try {
                const routeTableResponse = await EC2.describeRouteTables(routeTableParams).promise();
                console.log(`===============================${vpc.VpcId}===============================`);
                console.log(JSON.stringify(routeTableResponse, null, 2));
                console.log(`===================================================================================`);
                inProcess = false;
            } catch (err) {
                console.error(err);
            }
        } while (inProcess);
    }
})();
